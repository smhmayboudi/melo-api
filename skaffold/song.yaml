apiVersion: skaffold/v2beta4
kind: Config
metadata:
  name: melo-song
profiles:
  - name: cluster
    build:
      artifacts:
        - image: gitlab-repo.3re.ir/melobit/melo-api/melo/song
          kaniko:
            dockerfile: docker/development/song.Dockerfile
          sync:
            infer:
              - "apps/song/**/*.*"
              - "libs/**/*.*"
              - "type/**/*.*"
      cluster:
        namespace: melo
        dockerConfig:
          secretName: kaniko-secret
        serviceAccount: kaniko-service-account
  - name: local
    build:
      artifacts:
        - image: melo/song
          docker:
            dockerfile: docker/development/song.Dockerfile
          sync:
            infer:
              - "apps/song/**/*.*"
              - "libs/**/*.*"
              - "type/**/*.*"
      tagPolicy:
        sha256: {}
      local:
        push: false
        useBuildkit: true
test:
  - image: melo/song
    structureTests:
      - skaffold/structure-test/song/file-existence-test.yaml
      - skaffold/structure-test/song/global-env-var.yaml
deploy:
  helm:
    releases:
      - name: melo
        chartPath: k8s/song
        artifactOverrides:
          image: melo/song
        namespace: melo
        wait: true
    flags:
      install:
        - --create-namespace
      upgrade:
        - --atomic
