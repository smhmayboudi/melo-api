apiVersion: skaffold/v2beta4
kind: Config
metadata:
  name: melo-melo-api
profiles:
  - name: cluster
    build:
      artifacts:
        - image: gitlab-repo.3re.ir/melobit/melo-api/melo/melo-api
          kaniko:
            dockerfile: docker/development/melo-api.Dockerfile
          sync:
            infer:
              - "apps/melo-api/**/*.*"
              - "libs/**/*.*"
              - "type/**/*.*"
      cluster:
        namespace: melo
        dockerConfig:
          secretName: kaniko-secret
        serviceAccount: kaniko-service-account
  - name: local
    build:
      artifacts:
        - image: melo/melo-api
          docker:
            dockerfile: docker/development/melo-api.Dockerfile
          sync:
            infer:
              - "apps/melo-api/**/*.*"
              - "libs/**/*.*"
              - "type/**/*.*"
      tagPolicy:
        sha256: {}
      local:
        push: false
        useBuildkit: true
test:
  - image: melo/melo-api
    structureTests:
      - skaffold/structure-test/melo-api/file-existence-test.yaml
      - skaffold/structure-test/melo-api/global-env-var.yaml
deploy:
  helm:
    releases:
      - name: melo
        chartPath: k8s/melo-api
        artifactOverrides:
          image: melo/melo-api
        namespace: melo
        wait: true
    flags:
      install:
        - --create-namespace
      upgrade:
        - --atomic
