version: "v1beta9"
commands:
  - command: "devspace use namespace melo && export COMMIT_SHA=`git describe --abbrev=0 --always --dirty` && echo COMMIT_SHA $COMMIT_SHA"
    name: "init"
images:
  melo-song:
    appendDockerfileInstructions:
    - "USER root"
    build:
      docker:
        disableFallback: true
        useBuildKit: true
    context: "../../"
    dockerfile: "./docker/development/Dockerfile"
    image: "localhost:5000/melo_song"
    injectRestartHelper: false
    preferSyncOverRebuild: true
    tags:
    - "${COMMIT_SHA}"
    - "latest"
deployments:
- helm:
    atomic: true
    chart:
      name: "./k8s"
    cleanupOnFail: true
    disableHooks: true
    replaceImageTags: false
    values:
      image:
        repository: "localhost:5000/melo_song"
        tag: "${COMMIT_SHA}"
    wait: true
  name: "melo-song"
dev:
  autoReload:
    deployments:
    - "melo-song"
    paths:
    - "../../package.json"
  logs:
    images:
    - "melo-song"
  ports:
  - forward:
    - port: 9229
      remotePort: 9229
    imageName: "melo-song"
  sync:
  - containerPath: "/app/apps/song"
    excludePaths:
    - "**/.devspace"
    - "**/.gitlab-ci.yml"
    - "**/BUILD.bazel"
    - "**/Tiltfile"
    - "**/Tiltfile.bazel"
    - "**/devspace.yaml"
    - "**/docker"
    - "**/k8s"
    - "**/tilt_modules"
    imageName: "melo-song"
    localSubPath: "./"
    onUpload:
      restartContainer: false
    waitInitialSync: true
  - containerPath: "/app/libs"
    excludePaths:
    - "**/.gitlab-ci.yml"
    - "**/BUILD.bazel"
    imageName: "melo-song"
    localSubPath: "../../libs"
    onUpload:
      restartContainer: false
    waitInitialSync: true
profiles:
- name: "debug"
  patches:
  - op: "add"
    path: "images.melo-action.entrypoint"
    value:
    - "./node_modules/.bin/nest"
    - "start"
    - "song"
    - "--debug=0.0.0.0:9229"
    - "--watch"
- name: "production"
  patches:
  - op: "remove"
    path: "images.melo-song.appendDockerfileInstructions"
  - op: "remove"
    path: "images.melo-song.preferSyncOverRebuild"
  - op: "replace"
    path: "images.melo-song.dockerfile"
    value: "./docker/Dockerfile"
